---
title: "DEP analysis"
author: "Rui Nascimento"
date: "19/01/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# DEP Analysis Test

```{r, message=FALSE}
library("DEP")
library("dplyr")
library("stringr")
library("rentrez")
library("org.Vvinifera.eg.db")
library("AnnotationDbi")
library("topGO")
```


## Label-Free Quantification

```{r}
data <- read.delim("Vitis_Protein_Groups.tsv", header=TRUE, sep="\t", stringsAsFactors = FALSE)
dim(data)
data <- filter(data, Reverse != "+", Potential.contaminant != "+")
dim(data)
```

Are any there duplicated genes?

```{r}
data$Protein.IDs %>% duplicated() %>% any()
```

Define functions for later use

```{r}
getGI <- function(s) {
  ## Helper function to extract GI from fasta headers in MAxQuant results
  ex <- str_extract_all(string = s, pattern = "gi\\|[:digit:]+\\|")[[1]]
  str_extract_all(string = ex, pattern = "[:digit:]+",simplify = T)[,1]
}

get1GI <- function(x){
 # Get 1 GI, priority to GI with XP annotation, otherwise get the first GI 
  if (str_detect(x, "XP")) {
    gi <- str_extract(string = x, pattern = "(?<=gi\\|)[:number:]+(?=\\|ref\\|XP)")
  } else {
      gi <- str_extract(string = x, pattern = "(?<=gi\\|)[:number:]+")
    }
  return(gi)
}

protein2gene <- function(x, api_key = api_key){
  gene_gi <- entrez_link(dbfrom="protein", db="gene", id = x, api_key = api_key)$links$protein_gene[1]
  if (is.null(gene_gi)){gene_gi <- ""}
  return(gene_gi[[1]])
}
```

Get protein names
```{r}

get_names <- function(prot_ids) {
  gi <- getGI(prot_ids)
  name <-  lapply(gi, function(id) (entrez_summary(id = id, db = "protein")$title))
  return(paste(name, collapse = ";"))
}

```


```{r}
#Get 1 GI and add to ID column
data$ID <- as.character(sapply(data$Protein.IDs, get1GI))
data$name <- as.character(data$Protein.IDs)
```


```{r}
data_unique <- make_unique(data, names = "name", ids = "ID", delim = ";")
```


## Generate a SummarizedExperiment object using an experimental design
```{r}
LFQ_columns <- grep("Intensity.", colnames(data)) # get LFQ column numbers
experimental_design <- read.delim("ExperimentalDesign.tsv", header=TRUE, sep="\t", stringsAsFactors = FALSE)
data_se <- make_se(data, LFQ_columns, experimental_design)
```


```{r}
plot_frequency(data_se)
```


## Filter missing values

Filter for proteins that are identified in 2 out of 3 replicates of at least one condition

```{r}
data_filt <- filter_missval(data_se, thr = 1)
```

Barplot of the number of identified proteins per samples

```{r}
plot_numbers(data_filt)
```

Barplot of the protein identification overlap between sample

```{r}
plot_coverage(data_filt)
```

## Normalization

Normalize the data
```{r}
data_norm <- normalize_vsn(data_filt)
```

Visualize Normalization

```{r}
plot_normalization(data_filt, data_norm)
```

## Missing values imputation

View missing values

```{r}
plot_missval(data_filt)
```

Plot intensity distributions and cumulative fraction of proteins with and without missing values
```{r}
plot_detect(data_filt)
```

Impute missing data using random draws from a Gaussian distribution centered around a minimal value (for MNAR)

```{r, message=FALSE}
data_imp <- impute(data_norm, fun = "MinProb", q = 0.01)
```

Intensity distributions before and after imputation

```{r}
plot_imputation(data_norm, data_imp)
```

## DE analysis Global

```{r}
data_diff_manual <- test_diff(data_imp, type = "manual", 
                              test = c("Ri6h_vs_Rm6h", "Ri12h_vs_Rm12h", "Ri24h_vs_Rm24h"))
```

```{r}
dep <- add_rejections(data_diff_manual, alpha = 0.1, lfc = log2(1.5))
```

## Results Table

```{r}
# Generate a results table
data_results <- get_results(dep)

# Number of significant proteins
data_results %>% filter(significant) %>% nrow()
```

Get Gene IDs from Protein IDs from NCBI servers

```{r}
api_key <- readLines("~/.ncbi_api")
data_results$GENE_GI <- sapply(data_results$ID, protein2gene, api_key = api_key, simplify = TRUE, USE.NAMES = FALSE)
```


```{r}
plot_pca(dep, x = 1, y = 2, n = 500, point_size = 4)
```

## 6 hpi

### PCA

```{r}
plot_pca(dep[, c(7,8,9,16,17,18)], x = 1, y = 2, n = 500, point_size = 4)

```

### Go enrichment analysis

Genererate genelist of differentially accomulated proteins using the Gene IDs

```{r}
geneList6h <- data_results$Ri6h_vs_Rm6h_p.val
names(geneList6h) <- data_results$GENE_GI
head(geneList6h)
```

Run the tests

```{r}
GOdata6h <- new("topGOdata",
              ontology = "BP",
              allGenes = geneList6h,
              geneSelectionFun = function(x) (x < 0.05),
              annot = annFUN.org , mapping = "org.Vvinifera.eg.db",
              ID = "entrez")

resultKS6h <- runTest(GOdata6h, algorithm = "weight01", statistic = "fisher")

tab6h <- GenTable(GOdata6h, raw.p.value = resultKS6h, topNodes = length(resultKS6h@score), numChar = 120)
# Convert p.value to numeric
tab6h$raw.p.value <- as.numeric(tab6h$raw.p.value)

head(tab6h, 15)

par(cex = 0.6)
showSigOfNodes(GOdata6h, score(resultKS6h), firstSigNodes = 5, useInfo = "def")
par(cex = 1)
```


## 12 hpi

```{r}
plot_pca(dep[, c(1,2,3,10,11,12)], x = 1, y = 2, n = 500, point_size = 4)
```

Genererate genelist of differentially accomulated proteins using the Gene IDs

```{r}
geneList12h <- data_results$Ri12h_vs_Rm12h_p.val
names(geneList12h) <- data_results$GENE_GI
head(geneList12h)
```

Run the tests

```{r}
GOdata12h <- new("topGOdata",
                ontology = "BP",
                allGenes = geneList12h,
                geneSelectionFun = function(x) (x < 0.05),
                annot = annFUN.org , mapping = "org.Vvinifera.eg.db",
                ID = "entrez")

resultKS12h <- runTest(GOdata12h, algorithm = "weight01", statistic = "fisher")

tab12h <- GenTable(GOdata12h, raw.p.value = resultKS12h, topNodes = length(resultKS12h@score), numChar = 120)
# Convert p.value to numeric
tab12h$raw.p.value <- as.numeric(tab12h$raw.p.value)

head(tab12h, 15)

par(cex = 0.6)
showSigOfNodes(GOdata12h, score(resultKS12h), firstSigNodes = 5, useInfo = "def")
par(cex = 1)
```


## 24 hpi

```{r}
plot_pca(dep[, c(4,5,6,13,14,15)], x = 1, y = 2, n = 500, point_size = 4)
```

Genererate genelist of differentially accomulated proteins using the Gene IDs

```{r}
geneList24h <- data_results$Ri24h_vs_Rm24h_p.val
names(geneList24h) <- data_results$GENE_GI
head(geneList24h)
```

Run the tests

```{r}
GOdata24h <- new("topGOdata",
                 ontology = "BP",
                 allGenes = geneList24h,
                 geneSelectionFun = function(x) (x < 0.05),
                 annot = annFUN.org , mapping = "org.Vvinifera.eg.db",
                 ID = "entrez")

resultKS24h <- runTest(GOdata24h, algorithm = "weight01", statistic = "fisher")

tab24h <- GenTable(GOdata24h, raw.p.value = resultKS24h, topNodes = length(resultKS24h@score), numChar = 120)
# Convert p.value to numeric
tab24h$raw.p.value <- as.numeric(tab24h$raw.p.value)

head(tab24h, 15)

par(cex = 0.6)
showSigOfNodes(GOdata24h, score(resultKS24h), firstSigNodes = 5, useInfo = "def")
par(cex = 1)
```



```{r}
# Generate a wide data.frame
df_wide <- get_df_wide(dep)
# Generate a long data.frame
df_long <- get_df_long(dep)

write.table(df_wide, file = "results_wide.tsv", sep = "\t", row.names = FALSE)
write.table(df_long, file = "results_long.tsv", sep = "\t", row.names = FALSE)
write.table(data_results, "Results.tsv", sep = "\t", row.names = FALSE)
```

